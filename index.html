<!-- ã™ã§ã«ãƒšãƒ¼ã‚¸ã®ä¸­èº«ã¯çœç•¥ -->
<!-- â†“ã“ã“ãŒãƒšãƒ¼ã‚¸ã®æœ€å¾Œã® <script> ã‚¿ã‚°ã§ã™ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("closeBtn");
  const sendBtn = document.getElementById("sendBtn");
  const modalTitle = document.getElementById("modal-title");
  const modalPrice = document.getElementById("modal-price");
  const paylinkInput = document.getElementById("paylink");
  const firstModal = document.getElementById("firstModal");
  const firstBtn = document.getElementById("first-button");
  const firstClose = document.getElementById("firstClose");
  const firstSubmitBtn = document.getElementById("firstSubmitBtn");
  const nicknameInput = document.getElementById("nickname");

  const supportBtn = document.getElementById("support-button");
  const supportModal = document.getElementById("supportModal");
  const supportClose = document.getElementById("supportClose");

  let selectedProduct = null;

  document.querySelectorAll(".buy-button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const product = btn.closest(".product");
      const title = product.querySelector(".title").textContent;
      const price = product.querySelector(".price").textContent;

      selectedProduct = { title, price };
      modalTitle.textContent = title;
      modalPrice.textContent = `ä¾¡æ ¼: ${price}`;
      paylinkInput.value = "";
      modal.style.display = "flex";

      // ã™ã¹ã¦éžè¡¨ç¤ºã«
      document.getElementById("mekki-fields").style.display = "none";
      document.getElementById("camber-fields").style.display = "none";
      document.getElementById("horsepower-fields").style.display = "none";
      document.getElementById("idchange-fields").style.display = "none";

      // ã‚¿ã‚¤ãƒˆãƒ«ã§åˆ¤å®šã—ã¦è¡¨ç¤º
      if (title.includes("ãƒ¡ãƒƒã‚­")) {
        document.getElementById("mekki-fields").style.display = "block";
      } else if (title.includes("ã‚­ãƒ£ãƒ³ãƒãƒ¼")) {
        document.getElementById("camber-fields").style.display = "block";
      } else if (title.includes("é¦¬åŠ›å¤‰æ›´")) {
        document.getElementById("horsepower-fields").style.display = "block";
      } else if (title.includes("IDå¤‰æ›´")) {
        document.getElementById("idchange-fields").style.display = "block";
      }
    });
  });

  closeBtn.onclick = () => modal.style.display = "none";
  firstClose.onclick = () => firstModal.style.display = "none";

  window.onclick = (event) => {
    if (event.target === modal) modal.style.display = "none";
    if (event.target === firstModal) firstModal.style.display = "none";
    if (event.target === supportModal) supportModal.style.display = "none";
  };

  sendBtn.onclick = async () => {
    if (!selectedProduct) return;

    const nickname = localStorage.getItem("nickname") || "";
    if (!nickname) {
      alert("ã€Žã¾ãšã¯ã“ã“ï¼ã€ã‹ã‚‰ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ç™»éŒ²ã‚’è¡Œã£ã¦ã‹ã‚‰å†åº¦ãŠé¡˜ã„ã—ã¾ã™ã€‚");
      modal.style.display = "none";
      return;
    }

    const paylink = document.getElementById("paylink").value.trim();
    const gametag = document.getElementById("gametag").value.trim();
    const secretword = document.getElementById("secretword").value.trim();

    if (!paylink || !gametag || !secretword) {
      alert("ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const fields = [
      { name: "ðŸ“› ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ", value: `\`${nickname}\`` },
      { name: "ðŸ“¦ å•†å“å", value: `\`${selectedProduct.title}\`` },
      { name: "ðŸ’° é‡‘é¡", value: `\`${selectedProduct.price}\`` },
      { name: "ðŸ“§ ãƒ¡ã‚¢ãƒ‰", value: gametag },
      { name: "ðŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", value: secretword },
      { name: "ðŸ”— é€é‡‘ãƒªãƒ³ã‚¯", value: paylink }
    ];

    // ãƒ¡ãƒƒã‚­
    if (document.getElementById("mekki-fields").style.display !== "none") {
      const level = document.getElementById("mekki-level").value;
      const car = document.getElementById("mekki-car").value.trim();
      if (level && car) {
        fields.push({ name: "ðŸªž ãƒ¡ãƒƒã‚­åº¦åˆã„", value: level });
        fields.push({ name: "ðŸš— è»Šç¨®ï¼ˆãƒ¡ãƒƒã‚­ï¼‰", value: car });
      }
    }

    // ã‚­ãƒ£ãƒ³ãƒãƒ¼
    if (document.getElementById("camber-fields").style.display !== "none") {
      const angle = document.getElementById("camber-angle").value.trim();
      const car = document.getElementById("camber-car").value.trim();
      if (angle && car) {
        fields.push({ name: "ðŸ“ ã‚­ãƒ£ãƒ³ãƒãƒ¼è§’åº¦", value: angle });
        fields.push({ name: "ðŸš— è»Šç¨®ï¼ˆã‚­ãƒ£ãƒ³ãƒãƒ¼ï¼‰", value: car });
      }
    }

    // é¦¬åŠ›
    if (document.getElementById("horsepower-fields").style.display !== "none") {
      const hp = document.getElementById("horsepower-value").value.trim();
      const car = document.getElementById("horsepower-car").value.trim();
      if (hp && car) {
        fields.push({ name: "ðŸŽï¸ é¦¬åŠ›", value: hp });
        fields.push({ name: "ðŸš— è»Šç¨®ï¼ˆé¦¬åŠ›ï¼‰", value: car });
      }
    }

    // IDå¤‰æ›´
    if (document.getElementById("idchange-fields").style.display !== "none") {
      const newid = document.getElementById("idchange-value").value.trim();
      const contact = document.getElementById("idchange-contact").value.trim();
      const url = document.getElementById("idchange-contact-url").value.trim();
      if (newid) fields.push({ name: "ðŸ†” å¤‰æ›´å¾ŒID", value: newid });
      if (contact) fields.push({ name: "ðŸ“ž é€£çµ¡æ‰‹æ®µ", value: contact });
      if (url) fields.push({ name: "ðŸŒ é€£çµ¡å…ˆURL", value: url });
    }

    const payload = {
      embeds: [
        {
          title: "ðŸ›’ è³¼å…¥ä¾é ¼é€šçŸ¥",
          color: 0x5cd65c,
          fields: fields,
          timestamp: new Date().toISOString()
        }
      ]
    };

    try {
      const webhookURL = "https://discord.com/api/webhooks/1357979247045513256/LmGof6L_UyBoTEI-r9KSzP9guAe-PBI_GEeTYwBBftpArDXPe0ye8MWJGzUyzvyqkkRe";
      await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      alert("é€ä¿¡ã—ã¾ã—ãŸï¼");
      modal.style.display = "none";
    } catch (e) {
      console.error(e);
      alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
    }
  };

  firstBtn.addEventListener("click", () => {
    firstModal.style.display = "flex";
  });

  firstSubmitBtn.addEventListener("click", async () => {
    const nickname = nicknameInput.value.trim();
    if (!nickname) {
      alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const payload = {
      embeds: [
        {
          title: "ðŸš€ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²é€šçŸ¥",
          color: 0x5cd65c,
          fields: [
            {
              name: "ðŸ’› ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ",
              value: `\`${nickname}\``
            }
          ],
          timestamp: new Date().toISOString()
        }
      ]
    };

    try {
      const webhookURL = "https://discord.com/api/webhooks/1357979180867911861/BHDfPbyrTmfqc-dM2gak7Dq8X3h3mCsqH7pDB7OeRWzDkDqNxJRyVKOZwTIwUvDnPqns";
      const res = await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Webhooké€ä¿¡å¤±æ•—");

      alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ é€ä¿¡å®Œäº†ï¼");
      firstModal.style.display = "none";
      nicknameInput.value = "";
      localStorage.setItem("nickname", nickname);
    } catch (err) {
      console.error(err);
      alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
    }
  });

  // âœ… ã‚µãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®å‹•ä½œ
  supportBtn.addEventListener("click", () => {
    supportModal.style.display = "flex";
  });

  supportClose.addEventListener("click", () => {
    supportModal.style.display = "none";
  });
});
</script>
