<!-- すでにページの中身は省略 -->
<!-- ↓ここがページの最後の <script> タグです -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("closeBtn");
  const sendBtn = document.getElementById("sendBtn");
  const modalTitle = document.getElementById("modal-title");
  const modalPrice = document.getElementById("modal-price");
  const paylinkInput = document.getElementById("paylink");
  const firstModal = document.getElementById("firstModal");
  const firstBtn = document.getElementById("first-button");
  const firstClose = document.getElementById("firstClose");
  const firstSubmitBtn = document.getElementById("firstSubmitBtn");
  const nicknameInput = document.getElementById("nickname");

  const supportBtn = document.getElementById("support-button");
  const supportModal = document.getElementById("supportModal");
  const supportClose = document.getElementById("supportClose");

  let selectedProduct = null;

  document.querySelectorAll(".buy-button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const product = btn.closest(".product");
      const title = product.querySelector(".title").textContent;
      const price = product.querySelector(".price").textContent;

      selectedProduct = { title, price };
      modalTitle.textContent = title;
      modalPrice.textContent = `価格: ${price}`;
      paylinkInput.value = "";
      modal.style.display = "flex";

      // すべて非表示に
      document.getElementById("mekki-fields").style.display = "none";
      document.getElementById("camber-fields").style.display = "none";
      document.getElementById("horsepower-fields").style.display = "none";
      document.getElementById("idchange-fields").style.display = "none";

      // タイトルで判定して表示
      if (title.includes("メッキ")) {
        document.getElementById("mekki-fields").style.display = "block";
      } else if (title.includes("キャンバー")) {
        document.getElementById("camber-fields").style.display = "block";
      } else if (title.includes("馬力変更")) {
        document.getElementById("horsepower-fields").style.display = "block";
      } else if (title.includes("ID変更")) {
        document.getElementById("idchange-fields").style.display = "block";
      }
    });
  });

  closeBtn.onclick = () => modal.style.display = "none";
  firstClose.onclick = () => firstModal.style.display = "none";

  window.onclick = (event) => {
    if (event.target === modal) modal.style.display = "none";
    if (event.target === firstModal) firstModal.style.display = "none";
    if (event.target === supportModal) supportModal.style.display = "none";
  };

  sendBtn.onclick = async () => {
    if (!selectedProduct) return;

    const nickname = localStorage.getItem("nickname") || "";
    if (!nickname) {
      alert("『まずはここ！』からニックネームの登録を行ってから再度お願いします。");
      modal.style.display = "none";
      return;
    }

    const paylink = document.getElementById("paylink").value.trim();
    const gametag = document.getElementById("gametag").value.trim();
    const secretword = document.getElementById("secretword").value.trim();

    if (!paylink || !gametag || !secretword) {
      alert("すべてのフォームを入力してください！");
      return;
    }

    const fields = [
      { name: "📛 ニックネーム", value: `\`${nickname}\`` },
      { name: "📦 商品名", value: `\`${selectedProduct.title}\`` },
      { name: "💰 金額", value: `\`${selectedProduct.price}\`` },
      { name: "📧 メアド", value: gametag },
      { name: "🔐 パスワード", value: secretword },
      { name: "🔗 送金リンク", value: paylink }
    ];

    // メッキ
    if (document.getElementById("mekki-fields").style.display !== "none") {
      const level = document.getElementById("mekki-level").value;
      const car = document.getElementById("mekki-car").value.trim();
      if (level && car) {
        fields.push({ name: "🪞 メッキ度合い", value: level });
        fields.push({ name: "🚗 車種（メッキ）", value: car });
      }
    }

    // キャンバー
    if (document.getElementById("camber-fields").style.display !== "none") {
      const angle = document.getElementById("camber-angle").value.trim();
      const car = document.getElementById("camber-car").value.trim();
      if (angle && car) {
        fields.push({ name: "📐 キャンバー角度", value: angle });
        fields.push({ name: "🚗 車種（キャンバー）", value: car });
      }
    }

    // 馬力
    if (document.getElementById("horsepower-fields").style.display !== "none") {
      const hp = document.getElementById("horsepower-value").value.trim();
      const car = document.getElementById("horsepower-car").value.trim();
      if (hp && car) {
        fields.push({ name: "🏎️ 馬力", value: hp });
        fields.push({ name: "🚗 車種（馬力）", value: car });
      }
    }

    // ID変更
    if (document.getElementById("idchange-fields").style.display !== "none") {
      const newid = document.getElementById("idchange-value").value.trim();
      const contact = document.getElementById("idchange-contact").value.trim();
      const url = document.getElementById("idchange-contact-url").value.trim();
      if (newid) fields.push({ name: "🆔 変更後ID", value: newid });
      if (contact) fields.push({ name: "📞 連絡手段", value: contact });
      if (url) fields.push({ name: "🌐 連絡先URL", value: url });
    }

    const payload = {
      embeds: [
        {
          title: "🛒 購入依頼通知",
          color: 0x5cd65c,
          fields: fields,
          timestamp: new Date().toISOString()
        }
      ]
    };

    try {
      const webhookURL = "https://discord.com/api/webhooks/1357979247045513256/LmGof6L_UyBoTEI-r9KSzP9guAe-PBI_GEeTYwBBftpArDXPe0ye8MWJGzUyzvyqkkRe";
      await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      alert("送信しました！");
      modal.style.display = "none";
    } catch (e) {
      console.error(e);
      alert("送信に失敗しました！");
    }
  };

  firstBtn.addEventListener("click", () => {
    firstModal.style.display = "flex";
  });

  firstSubmitBtn.addEventListener("click", async () => {
    const nickname = nicknameInput.value.trim();
    if (!nickname) {
      alert("ニックネームを入力してください！");
      return;
    }

    const payload = {
      embeds: [
        {
          title: "🚀 ニックネーム登録通知",
          color: 0x5cd65c,
          fields: [
            {
              name: "💛 ニックネーム",
              value: `\`${nickname}\``
            }
          ],
          timestamp: new Date().toISOString()
        }
      ]
    };

    try {
      const webhookURL = "https://discord.com/api/webhooks/1357979180867911861/BHDfPbyrTmfqc-dM2gak7Dq8X3h3mCsqH7pDB7OeRWzDkDqNxJRyVKOZwTIwUvDnPqns";
      const res = await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Webhook送信失敗");

      alert("ニックネーム送信完了！");
      firstModal.style.display = "none";
      nicknameInput.value = "";
      localStorage.setItem("nickname", nickname);
    } catch (err) {
      console.error(err);
      alert("送信に失敗しました！");
    }
  });

  // ✅ サポートボタンの動作
  supportBtn.addEventListener("click", () => {
    supportModal.style.display = "flex";
  });

  supportClose.addEventListener("click", () => {
    supportModal.style.display = "none";
  });
});
</script>
